#!/usr/bin/env python3

import subprocess
import webbrowser
import sys

try:
    remote_url = subprocess.check_output(['git', 'config', '--get', 'remote.origin.url']).decode('utf-8').strip()
    branch = subprocess.check_output(['git', 'rev-parse', '--abbrev-ref', 'HEAD']).decode('utf-8').strip()
except subprocess.CalledProcessError:
    print("Error: Not a git repository or no remote origin configured")
    sys.exit(1)

url = None


def ssh_to_web_url(remote_url):
    """Convert SSH git URL to web URL for common providers."""
    url = None
    # Handle git@host:user/repo.git format
    if ':' in remote_url:
        host_part = remote_url.split('@')[1].split(':')[0] if '@' in remote_url else ''
        repo = remote_url.split(':')[1].split('.git')[0]

        if 'github.com' in host_part:
            url = 'https://github.com/%s/tree/%s' % (repo, branch)
        elif 'gitlab.com' in host_part:
            url = 'https://gitlab.com/%s/-/tree/%s' % (repo, branch)
        elif 'bitbucket.org' in host_part:
            url = 'https://bitbucket.org/%s/src/%s' % (repo, branch)
    return url


if '@' in remote_url:
    url = ssh_to_web_url(remote_url)

if remote_url.startswith('http') and remote_url.endswith('.git'):
    url = remote_url.split('.git')[0]

# Handle HTTPS URLs without .git suffix
if remote_url.startswith('http') and not url:
    url = remote_url

if url:
    webbrowser.open_new_tab(url)
else:
    print("Not recognised: " + remote_url)
